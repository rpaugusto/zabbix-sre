{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
  <h1 class="mb-3">
    <i class="bi bi-gear-fill me-2"></i>
    Configurações
  </h1>

  <div class="container mt-4" style="max-width: 600px;">
    <form method="POST">
        <div class="mb-3">
            <label class="form-label">Zabbix URL</label>
            <input
                type="text"
                name="zabbix_url"
                class="form-control"
                placeholder="https://zabbix.seudominio.com"
                value="{{ zabbix_url }}"
                required
            >
        </div>

        <div class="mb-3">
            <label class="form-label">API Token</label>
            <input
                type="password"
                name="zabbix_token"
                class="form-control"
                placeholder="{% if has_token %}******** (configurado){% else %}Cole o token{% endif %}"
                autocomplete="new-password"
            >
            <div class="form-text">
                O token não será exibido. Preencha apenas se quiser alterar.
            </div>
        </div>

        <div class="col-auto ms-auto"> 
          <div class="btn-group" role="group" aria-label="Actions">
            <button type="submit" class="btn btn-primary">Salve</button>
            <button type="button" id="btn-test-connection" class="btn btn-outline-primary" >Test</button>
            <a href="javascript:history.back()" class="btn btn-outline-secondary">← Voltar</a>
          </div>
        </div>
        <div id="test-result" class="mt-3"></div>
    </form>
</div>

<script>
document.getElementById("btn-test-connection").addEventListener("click", async () => {
    const url = document.querySelector("input[name='zabbix_url']").value;
    const token = document.querySelector("input[name='zabbix_token']").value;

    const resultDiv = document.getElementById("test-result");
    resultDiv.innerHTML = `
        <div class="alert alert-info">
            Testando conexão com o Zabbix...
        </div>
    `;

    try {
        const response = await fetch("/config/test", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                zabbix_url: url,
                zabbix_token: token || null
            })
        });

        const data = await response.json();

        if (data.success) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    ${data.message}
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    ${data.message}
                </div>
            `;
        }

    } catch (error) {
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                Erro inesperado ao testar conexão.
            </div>
        `;
    }
});
</script>

</div>
{% endblock %}
